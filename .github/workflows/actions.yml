name: build and tests

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
env:
  LC_ALL: "ja_JP.UTF-8"
  TZ: "Asia/Tokyo"

jobs:
  test:
    name: test
    runs-on: "ubuntu-latest"
    services:
      postgres:
        image: akira345/postgres13-ja_jp-locale:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: rss_db_test
        ports:
          - 5432:5432
        # needed because the postgres container does not provide a healthcheck
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      mailcatcher:
        image: schickling/mailcatcher
        ports:
          - 1080:1080
          - 1025:1025
      memcached:
        image: memcached:latest
    steps:
      - name: install packages
        run: sudo apt-get update && sudo apt-get install -y apt-utils locales locales-all fonts-ipafont libnss3 libx11-6 libnss3-dev libasound2-data  libasound2 xdg-utils chromium-browser
      - name: Setup Japanese locale
        run: echo "ja_JP.UTF-8 UTF-8" | sudo tee -a /etc/locale.gen && sudo locale-gen ja_JP.UTF-8
      - uses: actions/checkout@v3
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4.3'
          extensions: mbstring, opcache, memcached
          ini-values: date.timezone = "Asia/Tokyo",mbstring.internal_encoding = "UTF-8",mbstring.language = "Japanese",opcache.memory_consumption=128,opcache.interned_strings_buffer=8,opcache.max_accelerated_files=4000,opcache.revalidate_freq=2,opcache.fast_shutdown=1,opcache.enable_cli=1
      - name: Copy environment file
        run: cp .env.github .env
      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache
      - uses: actions/setup-node@v3
        with:
          node-version: 14
          cache: yarn
      - name: Install
        run: yarn install
      - name: Install Dependencies
        run: composer install --no-interaction --prefer-dist --no-suggest
      - name: Upgrade Chrome Driver
        run: php artisan dusk:chrome-driver `/opt/google/chrome/chrome --version | cut -d " " -f3 | cut -d "." -f1`
      - name: Start Chrome Driver
        run: ./vendor/laravel/dusk/bin/chromedriver-linux &
      - name: change permission for chromium driver
        run: chmod 755 vendor/laravel/dusk/bin/*
      - name: Generate key
        run: php artisan key:generate
      - name: clear view
        run: php artisan view:clear
      - name: view cache
        run: php artisan view:cache
      - name: migrate
        run: php artisan migrate --seed
      - name: Run Laravel Server
        run: php artisan serve --no-reload &
      - name: Clear config cache
        run: php artisan config:clear
      - name: E2E Test
        run:  php artisan dusk
      - name: Upload Screenshots
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: screenshots
          path: tests/Browser/screenshots
      - name: Upload Console Logs
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: console
          path: tests/Browser/console
      - name: runTest
        run: ./vendor/bin/phpunit --coverage-clover clover.xml
      - uses: codecov/codecov-action@v3
        with:
          files: ./clover.xml
